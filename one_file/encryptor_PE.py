import pefile
from cryptography.fernet import Fernet
import sys
import os

input_file = sys.argv[1]
input_filename_w_extention = os.path.basename(input_file)
# remove the .exe extension
input_filename = input_filename_w_extention[:-4]
output_filename = input_filename
output_path = os.getcwd()

# Load the executable file
pe = pefile.PE(input_filename_w_extention)

# Create a new section for the encrypted data
section = pe.sections[-1]
section_name = '.test'
section.VirtualAddress = (section.VirtualAddress + 0x1000 - 1) & ~(0x1000 - 1)
section.Misc_VirtualSize = 0x1000
section.SizeOfRawData = 0x1000
section.PointerToRawData = (section.PointerToRawData + 0x200 - 1) & ~(0x200 - 1)
section.Characteristics = 0xE0000020
section.Name = section_name.encode()

# Encrypt the software and store it in the new section
data = open(input_filename_w_extention, 'rb').read()
key = Fernet.generate_key()
cipher = Fernet(key)
encrypted_data = cipher.encrypt(data)
pe.set_bytes_at_offset(section.PointerToRawData, encrypted_data)

# Write the modified executable to disk
pe.write(f"{output_path}\PE_GEN_{output_filename}.exe")

# Load the modified executable into memory
data = open(f"{output_path}\PE_GEN_{output_filename}.exe", 'rb').read()
pe = pefile.PE(data=data)

# Decrypt the encrypted data and execute it in memory
cipher = Fernet(key)
decrypted_data = cipher.decrypt(pe.get_data(section.VirtualAddress, section.Misc_VirtualSize))
exec(decrypted_data)
